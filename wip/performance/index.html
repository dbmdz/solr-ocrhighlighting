
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.1, mkdocs-material-8.5.7">
    
    
      
        <title>Performance Tuning - Solr OCR Highlighting Plugin</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.20d9efc8.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.cbb835fc.min.css">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#performance-considerations" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-component="outdated" hidden>
        
      </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Solr OCR Highlighting Plugin" class="md-header__button md-logo" aria-label="Solr OCR Highlighting Plugin" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Solr OCR Highlighting Plugin
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Performance Tuning
            
          </span>
        </div>
      </div>
    </div>
    
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/dbmdz/solr-ocrhighlighting/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Solr OCR Highlighting Plugin" class="md-nav__button md-logo" aria-label="Solr OCR Highlighting Plugin" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Solr OCR Highlighting Plugin
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/dbmdz/solr-ocrhighlighting/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Introduction
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../installation/" class="md-nav__link">
        Installation
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../indexing/" class="md-nav__link">
        Indexing
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../alternatives/" class="md-nav__link">
        Indexing Alternative Terms
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../query/" class="md-nav__link">
        Querying
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../example/" class="md-nav__link">
        Example Setup
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Performance Tuning
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Performance Tuning
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#performance-analysis" class="md-nav__link">
    Performance Analysis
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#storage-layer" class="md-nav__link">
    Storage Layer
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#plugin-configuration" class="md-nav__link">
    Plugin configuration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#runtime-configuration" class="md-nav__link">
    Runtime configuration
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../formats/" class="md-nav__link">
        Supported Formats
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../changes/" class="md-nav__link">
        Change Log
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#performance-analysis" class="md-nav__link">
    Performance Analysis
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#storage-layer" class="md-nav__link">
    Storage Layer
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#plugin-configuration" class="md-nav__link">
    Plugin configuration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#runtime-configuration" class="md-nav__link">
    Runtime configuration
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  <a href="https://github.com/dbmdz/solr-ocrhighlighting/edit/master/docs/performance.md" title="Edit this page" class="md-content__button md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>


<h1 id="performance-considerations">Performance Considerations</h1>
<p>Highlighting based on locally stored files can take a long time, depending on the environment. This section gives some
hints on potential knobs to tune to improve the performance.</p>
<div class="admonition note">
<p class="admonition-title">Use JDK &gt;= 9</p>
<p>Java 9 introduced a feature called <a href="https://openjdk.java.net/jeps/254">String Compaction</a>
that has a significant impact on several hot code paths used during OCR highlighting.
<strong>You can expect a reduction in runtime of more than 50% if you use a JVM with string compaction
enabled compared to one without</strong> (assuming you're running on flash storage).
We highly recommend using the latest LTS OpenJDK version released after Java 9, which
as of September 2021 is OpenJDK 17.</p>
</div>
<h2 id="performance-analysis">Performance Analysis</h2>
<p>Before you start tuning the plugin, it is important to spend some time on analyzing the nature of the problems:</p>
<ul>
<li>Check Solr queries with <code>debug=timing</code>: How much of the response time is actually spent in the OCR highlighting
  component?</li>
<li>On the operating system level (if you're on a Linux system), use <a href="https://github.com/iovisor/bcc">BCC Tools</a>,
  especially <code>{nfs/xfs/ext/...}slower</code> and <code>{nfs/xfs/ext/...}dist</code> to check if the performance issues are due to I/O
  latency.</li>
</ul>
<h2 id="storage-layer">Storage Layer</h2>
<p>The plugin spends a lot of time on randomly reading small sections of the target files from disk. This means that
the performance characteristics of the underlying storage system have a huge effect on the performance of the plugin.</p>
<p>Important factors include:</p>
<ul>
<li><em>Random Read Latency</em>: What is the time required to seek to a random location and read a small chunk?</li>
<li><em>Number of possible parallel reads</em> (see below): Does the storage layer support more than one active reader?</li>
</ul>
<p>Generally speaking, local storage is better than remote storage (like NFS or CIFS), due to the network latency, and
flash-based storage is better than disk-based storage, due to the lower random read latency and the possibility to
do parallel reads. A RAID1/10 setup is preferred over a RAID0/JBOD setup, due to the increased potential for parallel reads.</p>
<h2 id="plugin-configuration">Plugin configuration</h2>
<p>The plugin offers the possibility to perform a <strong>concurrent read-ahead of highlighting target files</strong>. This will perform
"dummy" reads on multiple parallel threads, with the intent to fill the operating system's page cache with the contents
of the highlighting targets, so that the actual highlighting process is performed on data read from the cache (which
resides in main memory). This is mainly useful for storage layers that benefit from parallel reads, since the highlighting
process is strongly sequential and performing the read-ahead concurrently can reduce latency.</p>
<p>To enable it, add the <code>enablePreload=true</code> attribute on the OCR highlighting component in your core's <code>solrconfig.xml</code>.
It is important to accompany this with benchmarking and monitoring, the available settings should be tuned to the
environment:</p>
<ul>
<li><code>preloadReadSize</code>: Size in bytes of read-ahead block reads, should be aligned with file system block size
  (or <code>rsize</code> for NFS file systems). Defaults to <code>32768</code>.</li>
<li><code>preloadConcurrency</code>: Number of threads to perform read-ahead. Optimal settings have to be determined via
  experimentation. Defaults to <code>8</code>.</li>
</ul>
<p>This approach relies on the OS-level page cache, so make sure you have enough spare RAM available on your machine to
actually benefit from this! Use BCC's <code>*slower</code> tools to verify that it's a <code>solr-ocrhighlight</code> thread that performs
most of the reads and not the actual query thread (<code>qtp....</code>). If you run the same query twice, you shouldn't see a lot
of reads from either the <code>qtp...</code> or <code>solr-ocrhlighight</code> threads on  the second run.</p>
<p>Example configuration tuned for remote NFS storage mounted with <code>rsize=65536</code>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nt">&lt;searchComponent</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>  <span class="na">class=</span><span class="s">&quot;solrocr.OcrHighlightComponent&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>  <span class="na">name=</span><span class="s">&quot;ocrHighlight&quot;</span> <span class="na">enablePreload=</span><span class="s">&quot;true&quot;</span> <span class="na">preloadReadSize=</span><span class="s">&quot;65536&quot;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>  <span class="na">preloadConcurrency=</span><span class="s">&quot;8&quot;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="nt">/&gt;</span>
</code></pre></div></p>
<h2 id="runtime-configuration">Runtime configuration</h2>
<p>Another option to influence the performance of the plugin is to tune some runtime options for highlighting.
For any of these, refer to the <a href="https://dbmdz.github.io/solr-ocrhighlighting/query/">Querying section</a> for more details.</p>
<ul>
<li>If you're storing documents at the page-level in the index, you can set the <code>hl.ocr.trackPages</code> parameter to <code>false</code>
  (default is <code>true</code>). This will skip seeking backward in the input from the match position to find the containing
  page, which can be costly.</li>
<li>Tune the number of candidate passages for ranking with <code>hl.ocr.maxPassages</code>, which defaults to <code>100</code>. Lowering this is
  better for performance, but means that the resulting snippets might not be the most relevant in the document.</li>
<li>Change the limit (<code>hl.ocr.limitBlock</code>) and/or context block types (<code>hl.ocr.contextBlock</code>) to something lower in the
  block hierarchy to reduce the amount of reads in the OCR files. Another knob to tune is the number of context blocks
  for each hit (<code>hl.ocr.contextSize</code>), with the same effect.</li>
<li>The last resort if highlighting takes too long is to pass the <code>hl.ocr.timeAllowed</code> parameter, which stops
  highlighting any further documents if a given timeout is exceeded.</li>
</ul>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../example/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Example Setup" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Example Setup
            </div>
          </div>
        </a>
      
      
        
        <a href="../formats/" class="md-footer__link md-footer__link--next" aria-label="Next: Supported Formats" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Supported Formats
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../assets/javascripts/bundle.8492ddcf.min.js"></script>
      
    
  </body>
</html>